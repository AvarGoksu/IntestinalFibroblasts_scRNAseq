```{r}
rm(list = ls())
```


```{r}
library(openxlsx)
library(tidyverse)
library(ggpubr)
library(ggforce)
library(reshape2)
library(ggpubr)
library(org.Mm.eg.db)
library(AnnotationDbi)
library(enrichplot)
library(clusterProfiler)
library(msigdbr)
library(forcats)
library(ggrepel)
library(GSVA)
library(SingleCellExperiment)
library(scran)
library(ReactomePA)
```

```{r}
fit <- readRDS("/vol/ExtraVol/ParasiteDEX/parasite_glmGamPoi_fit_pseudobulked.RDS")
cnt <- fit[["data"]]@assays@data@listData[["counts"]]
sce <- SingleCellExperiment(assays = list(counts = cnt))
sce <- computeSumFactors(sce)
sce <- logNormCounts(sce)
normalized_counts <- logcounts(sce)

#Read the genomic feature table
genomic_features <- read.csv("/vol/ExtraVol/Genomic_Features.tsv", row.names = NULL, sep="\t")
genomic_features_unique <- genomic_features %>%
  dplyr::select(c(Symbol, Name)) %>%
  dplyr::distinct()
protein_coding_genes <- unique(subset(genomic_features, Gene.Type == "protein-coding")$Symbol)

normalized_counts <- subset(normalized_counts, rownames(normalized_counts) %in% protein_coding_genes)

#This is to add full names of the genes to the results
gene_metadata <- dplyr::select(genomic_features, c(Name, Symbol)) %>% 
  dplyr::rename("name" = "Symbol",
                "open_name" = "Name") %>%
  distinct()

entrezid_mapper <- AnnotationDbi::select(org.Mm.eg.db, keys=keys(org.Mm.eg.db), columns = c("SYMBOL", "ENTREZID")) %>% dplyr::rename("Symbol" = "SYMBOL")

normalized_counts_temp <- as.data.frame(normalized_counts) %>%
  dplyr::mutate(Symbol = rownames(normalized_counts))
normalized_counts_withENTREZID <- merge(normalized_counts_temp, entrezid_mapper, by="Symbol")
rownames(normalized_counts_withENTREZID) <- normalized_counts_withENTREZID$ENTREZID
normalized_counts_withENTREZID <- dplyr::select(normalized_counts_withENTREZID, -c(ENTREZID, Symbol))
rm(normalized_counts_temp)

infection_results_temp <- read.xlsx("/vol/ExtraVol/ParasiteDEX/DEX_results_parasite_infection_pseudobulked.xlsx")
infection_results_temp <- infection_results_temp %>% dplyr::rename("Symbol" = "name")
infection_results_temp <- subset(infection_results_temp, !grepl("^Rps|^Rpl", Symbol))
infection_results <- merge(infection_results_temp, entrezid_mapper, by="Symbol") %>%
  dplyr::arrange(desc(f_statistic))
top_infection_genes <- head(infection_results, n=nrow(infection_results)/100)$ENTREZID

# Define the path to the Excel file
file_infection_stage_dex <- "/vol/ExtraVol/ParasiteDEX/ParasiteDEX_OverallStageGenes_Pseudobulked.xlsx"

# Read each sheet into a corresponding data frame
early_infection_results_temp <- read.xlsx(file_infection_stage_dex, sheet = "early")
early_infection_results <- merge(early_infection_results_temp, entrezid_mapper, by="Symbol") %>%
  dplyr::arrange(desc(signed_adj_pval))

peak_infection_results_temp <- read.xlsx(file_infection_stage_dex, sheet = "peak")
peak_infection_results <- merge(peak_infection_results_temp, entrezid_mapper, by="Symbol") %>%
  dplyr::arrange(desc(signed_adj_pval))

repair_infection_results_temp <- read.xlsx(file_infection_stage_dex, sheet = "repair")
repair_infection_results <- merge(repair_infection_results_temp, entrezid_mapper, by="Symbol") %>%
  dplyr::arrange(desc(signed_adj_pval))
# interaction_results_temp <- read.xlsx("/vol/ExtraVol/ParasiteDEX/DEX_results_parasite_interaction_pseudobulked.xlsx")
# interaction_results_temp <- subset(interaction_results_temp, !grepl("^Rps|^Rpl", Symbol))
# interaction_results <- merge(interaction_results_temp, entrezid_mapper, by="Symbol") %>%
#   dplyr::arrange(desc(f_statistic)) %>% 
#   mutate(rank = seq(from = (n() - 1) / 2, to = -(n() - 1) / 2, by = -1))
# top_interaction_genes <- head(interaction_results, n=nrow(interaction_results)/100)$ENTREZID

reactome <- msigdbr(species = "Mus musculus", category = "C2", subcategory = "CP:REACTOME") %>% dplyr::select(gs_name, entrez_gene)
gobp <- msigdbr(species = "Mus musculus", category = "C5", subcategory = "GO:BP") %>% dplyr::select(gs_name, entrez_gene)
gomf <- msigdbr(species = "Mus musculus", category = "C5", subcategory = "GO:MF") %>% dplyr::select(gs_name, entrez_gene)
```

```{r}
enrichment_gobp_infection <- enrichGO(top_infection_genes, "org.Mm.eg.db",
                            ont = "BP", 
                            pvalueCutoff=0.05,
                            universe = infection_results$ENTREZID)
enrichment_gobp_infection <- simplify(enrichment_gobp_infection, cutoff = 0.7, by = "p.adjust", select_fun = min)
enrichment_gobp_infection <- setReadable(enrichment_gobp_infection, 'org.Mm.eg.db', "ENTREZID")
enrichment_gobp_infection_list <- enrichment_gobp_infection@result %>%
  arrange(p.adjust)
saveRDS(enrichment_gobp_infection, "/vol/ExtraVol/ParasiteDEX/GSEA/enrichment_gobp_infection.RDS")
write.xlsx(enrichment_gobp_infection_list, "/vol/ExtraVol/ParasiteDEX/GSEA/enrichment_gobp_infection_list.xlsx")
```

```{r}
enrichment_reactome_infection <- enrichPathway(top_infection_genes,
                            organism = "mouse", 
                            pvalueCutoff=0.05,
                            universe = infection_results$ENTREZID,
                            readable = TRUE)
enrichment_reactome_infection_list <- enrichment_reactome_infection@result %>%
  arrange(p.adjust)
saveRDS(enrichment_reactome_infection, "/vol/ExtraVol/ParasiteDEX/GSEA/enrichment_reactome_infection.RDS")
write.xlsx(enrichment_reactome_infection_list, "/vol/ExtraVol/ParasiteDEX/GSEA/enrichment_reactome_infection_list.xlsx")
```




