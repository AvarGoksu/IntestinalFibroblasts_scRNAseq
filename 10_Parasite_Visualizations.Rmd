```{r}
rm(list = ls())
```

```{r}
library(tidyverse)
library(data.table)
library(DESeq2)
library(conflicted)
library(openxlsx)
#library(clusterProfiler)
library(ComplexHeatmap)
library(circlize)
library(forcats)
library(RColorBrewer)
library(reshape2)
options("print.matrix" = FALSE)
```
```{r}
coldata <- as.data.frame(readr::read_csv("/vol/ExtraVol/DataHistory/Parasite_Clustered_Metadata.csv")) %>% dplyr::select(CellName, identity, stage, stage_grouped)
rownames(coldata) <- coldata$CellName

#We have two leiden clusters of Adamdec1+ cells. We want to group them together for DEX analysis. We also have two samples of uninfected cells. We should group them too.
coldata <- coldata %>%
  dplyr::mutate(condition = paste0(identity, "_", stage_grouped))
```

```{r}
cnt <- as.data.frame(readr::read_csv("/vol/ExtraVol/DataHistory/Parasite_Clustered_normalized.csv"))
rownames(cnt) <- cnt$CellName
cnt <- cnt %>% dplyr::select(-CellName)
cnt <- as.data.frame(t(cnt))
```

```{r}
representation <- dplyr::select(coldata, c(CellName, identity, stage_grouped)) %>%
  dplyr::group_by(identity, stage_grouped) %>%
  dplyr::summarise(n_cells = n()) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(identity) %>%
  dplyr::mutate(pct_cells = (n_cells*100)/sum(n_cells),
                n_cells_total = sum(n_cells)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(desc(n_cells_total))

representation$stage_grouped <- factor(representation$stage_grouped, levels=c("uninfected_adult", "early", "peak", "repair"))
representation$identity <- factor(representation$identity, levels=unique(representation$identity))

# Combine the data for both plots
representation_long <- representation %>%
  gather(key = "measure", value = "value", pct_cells, n_cells_total)
representation_long$measure <- factor(representation_long$measure, levels = c("pct_cells","n_cells_total"))
representation_long$stage_grouped <- fct_rev(factor(representation_long$stage_grouped, levels=c("uninfected_adult", "early", "peak", "repair")))
```

```{r}
marker_genes_df <- read.xlsx("/vol/ExtraVol/ParasiteDEX/ParasiteDEX_Markers.xlsx")
marker_genes_temp <- marker_genes_df %>%
  dplyr::arrange(desc(f_statistic)) %>%
  head(n=100) %>%
  dplyr::pull(Symbol)
marker_genes <- c(marker_genes_temp, "Cd81", "Hand1", "Ccl11", "Cd55")

infection_genes_df <- read.xlsx("/vol/ExtraVol/ParasiteDEX/ParasiteDEX_MainInfectionResults.xlsx")
infection_genes <- infection_genes_df %>%
  subset(!str_detect(Symbol, "Rpl|Rps")) %>%
  dplyr::arrange(desc(f_statistic)) %>%
  head(n=100) %>%
  dplyr::pull(Symbol)

interaction_genes_df <- read.xlsx("/vol/ExtraVol/ParasiteDEX/ParasiteDEX_InteractionResults.xlsx")
interaction_genes <- interaction_genes_df %>%
  subset(!str_detect(Symbol, "Rpl|Rps")) %>%
  dplyr::arrange(desc(f_statistic)) %>%
  head(n=100) %>%
  dplyr::pull(Symbol)

uninfected_cells_df <- coldata %>%
  subset(stage_grouped == "uninfected_adult")

uninfected_cells_df$identity <- factor(uninfected_cells_df$identity, levels=unique(representation$identity))

# Sort the dataframe by the factor levels
uninfected_cells_df <- uninfected_cells_df %>%
  arrange(identity)

uninfected_cells <- uninfected_cells_df$CellName

cnt_markers <- subset(cnt, rownames(cnt) %in% marker_genes)
cnt_markers <- cnt_markers %>% dplyr::select(all_of(uninfected_cells))

cnt_infection <- subset(cnt, rownames(cnt) %in% infection_genes)

cnt_infection_temp <- reshape2::melt(as.matrix(cnt_infection), value.name = "Expression", varnames = c("Symbol", "CellName"))
cnt_infection_long <- merge(cnt_infection_temp, coldata, by="CellName") %>% 
  dplyr::mutate(condition_Symbol = paste0(condition, "_", Symbol)) %>%
  dplyr::group_by(condition_Symbol) %>%
  dplyr::mutate(MeanExpression = mean(Expression)) %>%
  dplyr::ungroup()

cnt_infection_percentages <- cnt_infection_long %>%
  dplyr::mutate(condition_Symbol = paste0(condition, "_", Symbol)) %>%
  dplyr::group_by(condition_Symbol) %>%
  dplyr::summarise(
    nonzero_count_cells = sum(Expression != 0),
    total_count_cells = n()
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(pct_expressed = (nonzero_count_cells*100)/total_count_cells)

cnt_infection_scaled <- t(scale(t(cnt_infection)))
cnt_infection_scaled_temp <- reshape2::melt(as.matrix(cnt_infection_scaled), value.name = "ScaledExpression", varnames = c("Symbol", "CellName"))
cnt_infection_scaled_long <- merge(cnt_infection_scaled_temp, coldata, by="CellName") %>% 
  dplyr::mutate(condition_Symbol = paste0(condition, "_", Symbol)) %>%
  dplyr::group_by(condition_Symbol) %>%
  dplyr::mutate(MeanScaledExpression = mean(ScaledExpression)) %>%
  dplyr::ungroup()

cnt_infection_merged <- merge(cnt_infection_scaled_long, cnt_infection_percentages, by="condition_Symbol") %>%
  dplyr::select(MeanScaledExpression, identity, condition, Symbol, condition_Symbol, pct_expressed) %>%
  dplyr::distinct()

cnt_interaction <- subset(cnt, rownames(cnt) %in% interaction_genes)

cnt_interaction_temp <- reshape2::melt(as.matrix(cnt_interaction), value.name = "Expression", varnames = c("Symbol", "CellName"))
cnt_interaction <- merge(cnt_interaction_temp, coldata, by="CellName")
cnt_interaction <- cnt_interaction %>% 
  dplyr::mutate(condition_Symbol = paste0(condition, "_", Symbol)) %>%
  dplyr::group_by(condition_Symbol) %>%
  dplyr::mutate(MeanExpression = mean(Expression)) %>%
  dplyr::ungroup()

cnt_interaction_percentages <- cnt_interaction %>%
  dplyr::mutate(condition_Symbol = paste0(condition, "_", Symbol)) %>%
  dplyr::group_by(condition_Symbol) %>%
  dplyr::summarise(
    nonzero_count_cells = sum(Expression != 0),
    total_count_cells = n()
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(pct_expressed = (nonzero_count_cells*100)/total_count_cells)

cnt_interaction_merged <- merge(cnt_interaction, cnt_interaction_percentages, by="condition_Symbol") %>%
  dplyr::select(MeanExpression, identity, condition, Symbol, condition_Symbol, pct_expressed) %>%
  dplyr::distinct()

```

```{r}
# Define the bolder pastel colors
stage_colors <- c("uninfected_adult" = "#A9A9A9",
                  "early" = "#FFA07A",
                  "peak" = "#FF6347",
                  "repair" = "#77DD77")
```

```{r}
ggplot(cnt_infection_merged, aes(x=condition, y=Symbol))+
  geom_count(aes(size=pct_expressed, color=MeanScaledExpression))+
  scale_color_gradient2(
    low = "blue", 
    mid = "white", 
    high = "red", 
    midpoint = 0, 
    name = "Mean Scaled Expression"
  ) +
  theme_minimal() +
  labs(
    x = "Condition",
    y = "Symbol",
    size = "Percent Expressed"
  ) +
  theme(
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r}
# Combined faceted plot

facet_labels <- c("pct_cells" = "% of Cells", "n_cells_total" = "Number of Cells")
legend_order <- levels(fct_rev(factor(representation_long$stage_grouped)))

pdf("/vol/ExtraVol/ParasiteDEX/representations_parasite.pdf", width=10, height=5)
ggplot(data = representation_long, aes(x = value, y = fct_rev(identity), fill = stage_grouped)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = (stage_colors), breaks = legend_order) +
  facet_wrap(~ measure, scales = "free_x", labeller = as_labeller(facet_labels)) +
  theme_minimal(base_size = 15) +
  theme(
    panel.background = element_blank(),  # Remove panel background
    plot.background = element_blank(),  # Remove plot background
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    axis.line = element_line(color = "black"),  # Add axis lines
    legend.position = "bottom",  # Place legend at the bottom
    strip.text = element_text(size = 15),  # Adjust facet label size
    panel.spacing = unit(0.2, "lines"),  # Adjust space between facets
    panel.spacing.x = unit(0.2, "cm"),  # Adjust horizontal space between facets
    strip.placement = "outside",  # Place facet labels outside the plot
    plot.margin = margin(10, 10, 10, 10),  # Adjust plot margins
    plot.tag = element_text(size = 15),  # Adjust size of plot tag
    panel.grid = element_blank(),  # Remove panel grid lines
    strip.background = element_blank(),  # Remove strip background
    plot.tag.position = "bottomright",     # Position of plot tag
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  ) +
  labs(fill = "Infection Stage")  # Label for the legend
dev.off()
```

```{r}
ordered_data <- as.matrix(cnt_markers[,uninfected_cells_df$CellName])

group_labels <- factor(uninfected_cells_df$identity)
group_labels_unique <- unique(group_labels)
 
group_colors <- c(
  "PdgfraloCd55+ FB" = "#a6cee3",   
  "Cd81+ FB" = "#b2df8a",           
  "Pdgfralo FB" = "#fdbf6f",        
  "Pdgfrahi FB" = "#ff7f00",        
  "Ccl11+ MF" = "#6a3d9a",          
  "PdgfrahiCd55+ FB" = "#fb9a99",   
  "PdgfrahiJam2+ FB" = "#1f78b4",   
  "Pericytes" = "#b15928",          
  "Ccl11- MF" = "#CAB2D6",    
  "Hand1+" = "#8c8c8c"              
)
names(group_colors) <- group_labels_unique

column_annotation <- HeatmapAnnotation(
  group = group_labels,
  col = list(group = group_colors)
)

heatmap_colors <- colorRamp2(c(0, max(cnt_markers)),
                             c("grey100", "#800000"))

pdf("/vol/ExtraVol/ParasiteDEX/Heatmap_ParasiteMarkers.pdf", width=12, height=16)
Heatmap(ordered_data,
        name = "Normalized Counts", 
        show_column_names = FALSE,
        col = heatmap_colors,
        top_annotation = column_annotation,
        cluster_columns = FALSE,
        cluster_rows = TRUE,
        use_raster = FALSE
        )
dev.off()
```

```{r}
# Generate a palette with 10 colors
palette <- brewer.pal(n = 10, name = "Paired")

# Print the colors to see them
print(palette)
barplot(rep(1, 10), col = palette, border = NA)
```

